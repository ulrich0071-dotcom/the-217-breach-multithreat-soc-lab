<form version="1.1" theme="dark">
  <label>Phase 1 — Credential Abuse (Lab)</label>
  <description>Failed-logon bursts and the pattern of failures followed by a success.</description>
  <!-- Controls: Time + Sensitivity -->
  <!-- KPI row -->
  <!-- Trends & top offenders -->
  <!-- Near lockout / watchlist -->
  <!-- Failure reasons + logon types -->
  <!-- Correlated incidents -->
  <fieldset submitButton="false">
    <input type="time" token="time" searchWhenChanged="true">
      <label>Time range</label>
      <default>
        <earliestTime>-24h@h</earliestTime>
        <latestTime>now</latestTime>
      </default>
    </input>
    <input type="dropdown" token="minFails" searchWhenChanged="true">
      <label>Min failures (lab→prod)</label>
      <choice value="1">1 (debug)</choice>
      <choice value="2">2 (lab)</choice>
      <choice value="6">6 (near lockout)</choice>
      <choice value="10">10 (prod)</choice>
      <default>2</default>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Failed Logons (4625)</title>
      <single>
        <search>
          <query>
            <![CDATA[index=winsec EventCode=4625 | stats count]]>
          </query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
      </single>
    </panel>
    <panel>
      <title>Successful Logons (4624)</title>
      <single>
        <search>
          <query>
            <![CDATA[index=winsec EventCode=4624 | stats count]]>
          </query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
      </single>
    </panel>
    <panel>
      <title>Failure Bursts (≥ $minFails$)</title>
      <single>
        <search>
          <query>
            <![CDATA[
index=winsec EventCode=4625
| rex field=_raw "(?s)Account For Which Logon Failed:\s*(?<failsec>.*?)(?:Failure Information:|Process Information:|Network Information:|Detailed Authentication Information:|$)"
| rex field=failsec "(?i)Account Name:\s+(?<user>[^\r\n]+)"
| eval user=coalesce(user,TargetUserName,Account_Name,SubjectUserName)
| where user!="" AND user!="-"
| bin _time span=15m
| stats count as failures by _time user
| where failures>=$minFails$
| stats count
          ]]>
          </query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
      </single>
    </panel>
    <panel>
      <title>Brute Force → Success (≥ $minFails$)</title>
      <single>
        <search>
          <query>
            <![CDATA[
(index=winsec EventCode=4625) OR (index=winsec EventCode=4624)
| rex field=_raw "(?s)Account For Which Logon Failed:\s*(?<failsec>.*?)(?:Failure Information:|Process Information:|Network Information:|Detailed Authentication Information:|$)"
| rex field=failsec "(?i)Account Name:\s+(?<failUser>[^\r\n]+)"
| rex field=_raw "(?s)New Logon:.*?Account Name:\s+(?<newUser>[^\r\n]+)"
| eval user=coalesce(newUser,failUser,TargetUserName,Account_Name,SubjectUserName)
| where user!="" AND user!="-"
| eval is_fail=if(EventCode=4625,1,0), is_succ=if(EventCode=4624,1,0)
| bin _time span=5m
| stats sum(is_fail) as fails sum(is_succ) as succ by user _time
| where fails>=$minFails$ AND succ>=1
| stats count
          ]]>
          </query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <title>Failed Logons Over Time</title>
      <chart>
        <search>
          <query>
            <![CDATA[index=winsec EventCode=4625 | timechart span=5m count]]>
          </query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.chart">line</option>
      </chart>
    </panel>
    <panel>
      <title>Top Users (failures)</title>
      <table>
        <search>
          <query>
            <![CDATA[
index=winsec EventCode=4625
| rex field=_raw "(?s)Account For Which Logon Failed:\s*(?<failsec>.*?)(?:Failure Information:|Process Information:|Network Information:|Detailed Authentication Information:|$)"
| rex field=failsec "(?i)Account Name:\s+(?<user>[^\r\n]+)"
| eval user=coalesce(user,TargetUserName,Account_Name,SubjectUserName)
| where user!="" AND user!="-"
| stats count as failures by user
| sort - failures | head 10
          ]]>
          </query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <drilldown>
          <link target="_blank">search?q=search%20index%3Dwinsec%20(EventCode%3D4625%20OR%20EventCode%3D4624)%20user%3D$row.user$&amp;earliest=$time.earliest$&amp;latest=$time.latest$</link>
        </drilldown>
      </table>
    </panel>
    <panel>
      <title>Top Sources (failures)</title>
      <table>
        <search>
          <query>
            <![CDATA[
index=winsec EventCode=4625
| rex field=_raw "(?i)Source Network Address:\s+(?<src1>[^\r\n]+)"
| eval src=coalesce(src1,IpAddress,Source_Network_Address,WorkstationName,host)
| eval src=if(src="" OR src="-","unknown",src)
| stats count as failures by src
| sort - failures | head 10
          ]]>
          </query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Near Lockout Watchlist (≥ $minFails$ in 15m)</title>
      <table>
        <search>
          <query>
            <![CDATA[
index=winsec EventCode=4625
| rex field=_raw "(?s)Account For Which Logon Failed:\s*(?<failsec>.*?)(?:Failure Information:|Process Information:|Network Information:|Detailed Authentication Information:|$)"
| rex field=failsec "(?i)Account Name:\s+(?<user>[^\r\n]+)"
| rex field=_raw "(?i)Source Network Address:\s+(?<src1>[^\r\n]+)"
| eval user=coalesce(user,TargetUserName,Account_Name,SubjectUserName)
| eval src=coalesce(src1,IpAddress,Source_Network_Address,WorkstationName,host)
| where user!="" AND user!="-"
| bin _time span=15m
| stats count as failures values(src) as srcs by user
| where failures>=$minFails$
| sort - failures
          ]]>
          </query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="count">20</option>
        <drilldown>
          <link target="_blank">search?q=search%20index%3Dwinsec%20(EventCode%3D4625%20OR%20EventCode%3D4624)%20user%3D$row.user$&amp;earliest=$time.earliest$&amp;latest=$time.latest$</link>
        </drilldown>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Failure Reasons (Status/SubStatus)</title>
      <table>
        <search>
          <query>
            <![CDATA[
index=winsec EventCode=4625
| rex "(?i)Status:\s+(?<status>\S+)"
| rex "(?i)Sub Status:\s+(?<substatus>\S+)"
| eval reason=case(
  status=="0xC000006A","Bad password",
  status=="0xC0000064","No such user",
  status=="0xC0000234","Account locked",
  status=="0xC000006D","Bad user name/unknown",
  status=="0xC0000072","Account disabled",
  status=="0xC000006F","Account restricted",
  substatus=="0xC0000133","Clock skew",
  true(),"Other")
| stats count by reason status substatus
| sort - count
          ]]>
          </query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
      </table>
    </panel>
    <panel>
      <title>Logon Type Distribution (fail+success)</title>
      <chart>
        <search>
          <query>
            <![CDATA[
index=winsec (EventCode=4625 OR EventCode=4624)
| rex "(?i)Logon Type:\s+(?<lt>\d+)"
| eval logon_type=case(
  lt=="2","Interactive",
  lt=="3","Network",
  lt=="4","Batch",
  lt=="5","Service",
  lt=="7","Unlock",
  lt=="8","NetworkCleartext",
  lt=="9","NewCredentials",
  lt=="10","RemoteInteractive/RDP",
  lt=="11","CachedInteractive",
  true(),lt)
| stats count by logon_type
| sort - count
          ]]>
          </query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>First Success After Burst (details)</title>
      <table>
        <search>
          <query>
            <![CDATA[
(index=winsec EventCode=4625) OR (index=winsec EventCode=4624)
| rex field=_raw "(?s)Account For Which Logon Failed:\s*(?<failsec>.*?)(?:Failure Information:|Process Information:|Network Information:|Detailed Authentication Information:|$)"
| rex field=failsec "(?i)Account Name:\s+(?<failUser>[^\r\n]+)"
| rex field=_raw "(?s)New Logon:.*?Account Name:\s+(?<newUser>[^\r\n]+)"
| rex field=_raw "(?i)Source Network Address:\s+(?<src1>[^\r\n]+)"
| eval user=coalesce(newUser,failUser,TargetUserName,Account_Name,SubjectUserName)
| eval src=coalesce(src1,IpAddress,Source_Network_Address,WorkstationName,host)
| where user!="" AND user!="-"
| eval is_fail=if(EventCode=4625,1,0), is_succ=if(EventCode=4624,1,0)
| bin _time span=5m
| stats sum(is_fail) as fails sum(is_succ) as succ values(src) as srcs earliest(_time) as window_start latest(_time) as window_end by user _time
| where fails>=$minFails$ AND succ>=1
| eval window_start=strftime(window_start,"%Y-%m-%d %H:%M:%S"), window_end=strftime(window_end,"%Y-%m-%d %H:%M:%S")
| table window_start window_end user fails succ srcs
| sort - window_end
          ]]>
          </query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="count">20</option>
        <drilldown>
          <link target="_blank">search?q=search%20index%3Dwinsec%20(EventCode%3D4625%20OR%20EventCode%3D4624)%20user%3D$row.user$&amp;earliest=$time.earliest$&amp;latest=$time.latest$</link>
        </drilldown>
      </table>
    </panel>
  </row>
</form>
